#!/usr/bin/env python3
"""
ä¸‹è½½é¢„ç¼–è¯‘çš„ DemBones å¯æ‰§è¡Œæ–‡ä»¶
=============================

è¿™ä¸ªè„šæœ¬ä¼šå°è¯•ä¸‹è½½é¢„ç¼–è¯‘çš„ DemBones å¯æ‰§è¡Œæ–‡ä»¶
å¦‚æœå¤±è´¥ï¼Œä¼šæŒ‡å¯¼ç”¨æˆ·å¦‚ä½•ç¼–è¯‘
"""

import os
import sys
import urllib.request
import subprocess

def download_precompiled_dembones():
    """å°è¯•ä¸‹è½½é¢„ç¼–è¯‘çš„ DemBones"""
    print("=== å°è¯•ä¸‹è½½é¢„ç¼–è¯‘çš„ DemBones ===")
    
    # ä¸€äº›å¯èƒ½çš„é¢„ç¼–è¯‘ç‰ˆæœ¬é“¾æ¥
    download_urls = [
        # è¿™äº›æ˜¯ç¤ºä¾‹ï¼Œå®é™…å¯èƒ½éœ€è¦æŸ¥æ‰¾çœŸå®çš„é¢„ç¼–è¯‘ç‰ˆæœ¬
        "https://github.com/electronicarts/dem-bones/releases/download/v1.0.0/dembones-windows.exe",
        "https://github.com/electronicarts/dem-bones/releases/download/latest/DemBones.exe",
    ]
    
    for url in download_urls:
        try:
            print(f"å°è¯•ä» {url} ä¸‹è½½...")
            urllib.request.urlretrieve(url, "demBones.exe")
            
            # æµ‹è¯•ä¸‹è½½çš„æ–‡ä»¶
            if test_dembones_executable("demBones.exe"):
                print("âœ“ ä¸‹è½½å¹¶éªŒè¯æˆåŠŸ!")
                return True
            else:
                print("âŒ ä¸‹è½½çš„æ–‡ä»¶æ— æ³•è¿è¡Œ")
                if os.path.exists("demBones.exe"):
                    os.remove("demBones.exe")
                    
        except Exception as e:
            print(f"âŒ ä¸‹è½½å¤±è´¥: {e}")
            continue
    
    return False

def test_dembones_executable(exe_path):
    """æµ‹è¯• DemBones å¯æ‰§è¡Œæ–‡ä»¶"""
    try:
        result = subprocess.run([exe_path, "--help"], 
                              capture_output=True, timeout=10, text=True)
        # æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ DemBones å¯æ‰§è¡Œæ–‡ä»¶
        output = (result.stdout + result.stderr).lower()
        return "dembones" in output or "usage" in output or result.returncode == 0
    except:
        return False

def create_simple_dembones_stub():
    """åˆ›å»ºä¸€ä¸ªç®€å•çš„ DemBones å­˜æ ¹ç”¨äºæµ‹è¯•"""
    print("\n=== åˆ›å»º DemBones æµ‹è¯•å­˜æ ¹ ===")
    
    stub_content = '''@echo off
echo DemBones Test Stub
echo This is a placeholder for testing purposes
echo Input file: %1
echo Output file: %2

REM åˆ›å»ºä¸€ä¸ªç®€å•çš„è¾“å‡ºæ–‡ä»¶
echo # DemBones Output (Stub) > %2
echo # This is generated by a test stub >> %2
echo w 0.8 0.2 >> %2
echo w 0.7 0.3 >> %2
echo w 0.6 0.4 >> %2
echo w 0.5 0.5 >> %2
echo w 0.4 0.6 >> %2
echo w 0.3 0.7 >> %2
echo w 0.2 0.8 >> %2
echo w 0.1 0.9 >> %2

exit /b 0
'''
    
    try:
        with open("demBones.bat", "w") as f:
            f.write(stub_content)
        
        print("âœ“ åˆ›å»ºäº† demBones.bat æµ‹è¯•å­˜æ ¹")
        print("  è¿™åªæ˜¯ä¸€ä¸ªæµ‹è¯•å­˜æ ¹ï¼Œä¼šç”Ÿæˆç®€å•çš„æƒé‡æ•°æ®")
        print("  ç”¨äºéªŒè¯æ•´ä¸ªæµç¨‹æ˜¯å¦æ­£å¸¸å·¥ä½œ")
        
        return True
        
    except Exception as e:
        print(f"âŒ åˆ›å»ºå­˜æ ¹å¤±è´¥: {e}")
        return False

def main():
    print("DemBones ä¸‹è½½è„šæœ¬")
    print("=" * 30)
    
    # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ DemBones
    existing_paths = ["demBones.exe", "DemBones.exe", "demBones.bat"]
    for path in existing_paths:
        if os.path.exists(path):
            if test_dembones_executable(path):
                print(f"âœ“ å·²æ‰¾åˆ°å¯ç”¨çš„ DemBones: {path}")
                return True
            else:
                print(f"âš ï¸ æ‰¾åˆ° {path} ä½†æ— æ³•è¿è¡Œ")
    
    # å°è¯•ä¸‹è½½é¢„ç¼–è¯‘ç‰ˆæœ¬
    if download_precompiled_dembones():
        return True
    
    print("\nâŒ æ— æ³•ä¸‹è½½é¢„ç¼–è¯‘ç‰ˆæœ¬")
    print("\né€‰æ‹©:")
    print("1. æ‰‹åŠ¨ä¸‹è½½å¹¶ç¼–è¯‘ DemBones")
    print("2. åˆ›å»ºæµ‹è¯•å­˜æ ¹ä»¥éªŒè¯æµç¨‹")
    print("3. ç›´æ¥ä½¿ç”¨ç®€åŒ–è’™çš®æƒé‡ï¼ˆæ— éœ€ DemBonesï¼‰")
    
    choice = input("\nè¯·é€‰æ‹© (1/2/3): ").strip()
    
    if choice == "1":
        print("\næ‰‹åŠ¨ç¼–è¯‘æŒ‡å—:")
        print("1. å®‰è£…ä¾èµ–:")
        print("   - CMake: https://cmake.org/download/")
        print("   - Git: https://git-scm.com/download/")
        print("   - Visual Studio: https://visualstudio.microsoft.com/downloads/")
        print("\n2. ä¸‹è½½æºç :")
        print("   git clone https://github.com/electronicarts/dem-bones.git")
        print("\n3. ç¼–è¯‘:")
        print("   cd dem-bones")
        print("   mkdir build && cd build")
        print("   cmake ..")
        print("   cmake --build . --config Release")
        print("\n4. å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶åˆ°å½“å‰ç›®å½•")
        
    elif choice == "2":
        return create_simple_dembones_stub()
        
    elif choice == "3":
        print("\nâœ“ å¯ä»¥ç›´æ¥ä½¿ç”¨ complete_vv_pipeline.py")
        print("  ç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨ç®€åŒ–è’™çš®æƒé‡ç®—æ³•")
        return True
    
    return False

if __name__ == "__main__":
    success = main()
    if success:
        print("\nğŸ‰ è®¾ç½®å®Œæˆ!")
        print("ç°åœ¨å¯ä»¥ä½¿ç”¨ complete_vv_pipeline.py äº†")
    else:
        print("\nâŒ è®¾ç½®å¤±è´¥")
    
    sys.exit(0 if success else 1)
